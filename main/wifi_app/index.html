<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32è®¾å¤‡é…ç½®</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --background-color: #f8fafc;
            --container-bg: #ffffff;
            --text-color: #333;
            --border-color: #e5e7eb;
            --secondary-bg: #f1f5f9;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --readonly-bg: #f3f4f6;
            --hover-bg: #f9fafb;
            --shadow-color: rgba(0,0,0,0.1);
            --input-bg: #ffffff;
            --dropdown-bg: #ffffff;
            --modal-bg: #ffffff;
            --toast-bg: #ffffff;
        }

        /* æ·±è‰²æ¨¡å¼å˜é‡ */
        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --background-color: #0f172a;
            --container-bg: #1e293b;
            --text-color: #f1f5f9;
            --border-color: #475569;
            --secondary-bg: #334155;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --readonly-bg: #64748b;
            --hover-bg: #475569;
            --shadow-color: rgba(0,0,0,0.3);
            --input-bg: #475569;
            --dropdown-bg: #475569;
            --modal-bg: #1e293b;
            --toast-bg: #334155;
        }

        /* è‡ªåŠ¨æ·±è‰²æ¨¡å¼æ£€æµ‹ */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --primary-color: #3b82f6;
                --background-color: #0f172a;
                --container-bg: #1e293b;
                --text-color: #f1f5f9;
                --border-color: #475569;
                --secondary-bg: #334155;
                --success-color: #10b981;
                --warning-color: #f59e0b;
                --danger-color: #ef4444;
                --readonly-bg: #64748b;
                --hover-bg: #475569;
                --shadow-color: rgba(0,0,0,0.3);
                --input-bg: #475569;
                --dropdown-bg: #475569;
                --modal-bg: #1e293b;
                --toast-bg: #334155;
            }
        }
        
        *, *::before, *::after { box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            line-height: 1.5;
            color: var(--text-color);
        }
        
        .container {
            text-align: center;
            padding: 2rem;
            background-color: var(--container-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
            max-width: 600px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        h1 { color: var(--primary-color); margin-bottom: 1.5rem; font-size: 1.75rem; font-weight: 600; user-select: none; }
        h2 { color: var(--text-color); font-size: 1.25rem; margin: 1rem 0; font-weight: 500; }
        p { color: #64748b; font-size: 1rem; margin-bottom: 1rem; }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #64748b;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            background-color: var(--hover-bg);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .keymap-content {
            display: none;
        }
        
        .keymap-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-element {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: inherit;
            background-color: var(--input-bg);
            color: var(--text-color);
            line-height: 1.5;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-element:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .custom-select {
            width: 100%;
            margin: 0.5rem 0;
            position: relative;
        }
        
        .select-selected {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--input-bg);
            cursor: pointer;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-color);
            line-height: 1.5;
            text-align: left;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            display: inline-block;
        }
        
        .select-selected:hover {
            border-color: var(--primary-color);
        }
        
        .select-selected:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .select-items {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            margin-top: 4px;
        }
        
        /* çŠ¶æ€æç¤ºæ ·å¼ */
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 12px var(--shadow-color);
            animation: slideInRight 0.3s ease;
            transition: all 0.3s ease;
        }
        
        .status-message.success {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-message.warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .status-message.error {
            background-color: var(--danger-color);
            color: white;
        }
        
        .status-message.info {
            background-color: var(--primary-color);
            color: white;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-sizing: border-box;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
        }
        
        .select-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: left;
            color: var(--text-color);
            background-color: var(--input-bg);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .select-item:hover {
            background-color: var(--hover-bg);
        }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹å¢å¼ºé€‰æ‹©æ¡†å¯¹æ¯”åº¦ */
        [data-theme="dark"] .form-element {
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        [data-theme="dark"] .select-selected {
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        [data-theme="dark"] .select-items {
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        
        [data-theme="dark"] .form-element:focus,
        [data-theme="dark"] .select-selected:focus,
        [data-theme="dark"] .select-selected:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2), 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5rem 0;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }
        
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #475569; }
        
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover:not(:disabled) { background-color: #059669; }
        
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; }
        
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-group { display: flex; gap: 0.5rem; justify-content: center; margin: 1rem 0; flex-wrap: wrap; }
        .btn-group .btn { flex: 1; min-width: 120px; }
        
        .wifi-section, .keymap-section { margin: 1.5rem 0; padding: 1.5rem; background-color: var(--secondary-bg); border-radius: 0.75rem; border: 1px solid var(--border-color); }
        .wifi-section { user-select: none; }
        .password-input { margin: 0.5rem 0; }
        
        .keymap-tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1rem; }
        .keymap-tab { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; font-weight: 500; color: #64748b; font-size: 0.9rem; }
        .keymap-tab.active { border-bottom-color: var(--primary-color); color: var(--primary-color); background-color: var(--hover-bg); }
        
        .keymap-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0; }
        
        .mode-switch { display: flex; justify-content: center; margin: 1rem 0; gap: 0.5rem; }
        .mode-btn { padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 0.5rem; background-color: white; color: var(--text-color); cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        .mode-btn:hover { border-color: var(--primary-color); background-color: var(--hover-bg); }
        .mode-btn.active { border-color: var(--primary-color); background-color: var(--primary-color); color: white; }
        
        .key-item { 
            background-color: var(--container-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 0.5rem; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            transition: all 0.3s ease;
            color: var(--text-color);
        }
        .key-item:hover { border-color: var(--primary-color); box-shadow: 0 2px 4px var(--shadow-color); }
        
        /* ç¡®ä¿æŒ‰é”®é¡¹å†…çš„æ‰€æœ‰æ–‡å­—éƒ½ä½¿ç”¨æ­£ç¡®çš„é¢œè‰² */
        .key-item * {
            color: var(--text-color);
        }
        
        .key-number { font-size: 0.8rem; color: var(--text-color); opacity: 0.7; margin-bottom: 5px; }
        .key-value { font-size: 1rem; font-weight: 500; color: var(--text-color); }
        .key-select { width: 100%; padding: 5px; margin-top: 5px; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 0.9rem; background-color: var(--input-bg); color: var(--text-color); }
        
        .readonly { background-color: var(--readonly-bg); cursor: not-allowed; }
        .readonly .key-select { background-color: var(--readonly-bg); cursor: not-allowed; }
        
        .combo-editor h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .combo-editor label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .combo-editor input[type="checkbox"] {
            margin-right: 0.25rem;
        }
        
        .combo-editor select {
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.9rem;
        }
        
        .combo-editor button {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .combo-editor button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .keymap-status {
            padding: 10px;
            border-radius: 0.5rem;
            margin: 1rem 0;
            text-align: left;
        }
        
        .status-success {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success-color);
        }
        
        .status-error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger-color);
        }
        
        .status-warning {
            background-color: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning-color);
        }
        
        /* ç°ä»£åŒ–æç¤ºæ¡†æ ·å¼ */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            max-width: 300px;
        }
        
        .toast {
            background: var(--toast-bg);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
            border-left: 4px solid var(--primary-color);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            overflow: hidden;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
            max-height: 200px;
        }
        
        .toast.hide {
            transform: translateX(100%);
            opacity: 0;
            max-height: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .toast-success {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02));
        }
        
        .toast-error {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(239, 68, 68, 0.02));
        }
        
        .toast-warning {
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.02));
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .toast-success .toast-icon {
            background: var(--success-color);
            color: white;
        }
        
        .toast-error .toast-icon {
            background: var(--danger-color);
            color: white;
        }
        
        .toast-warning .toast-icon {
            background: var(--warning-color);
            color: white;
        }
        
        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-color);
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 16px;
            color: var(--border-color);
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .toast-close:hover {
            background: var(--hover-bg);
            color: var(--text-color);
        }
        
        /* å±‚åç§°ç¼–è¾‘å¯¹è¯æ¡†æ ·å¼ */
        .layer-name-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        
        .layer-name-modal.show {
            display: flex;
        }
        
        .layer-name-content {
            background: var(--modal-bg);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px var(--shadow-color), 0 10px 10px -5px var(--shadow-color);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .layer-name-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .layer-name-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }
        
        .layer-name-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .layer-name-close:hover {
            background-color: var(--hover-bg);
            color: var(--text-color);
        }
        
        .layer-name-item {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background-color: var(--secondary-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .layer-name-label {
            min-width: 80px;
            font-weight: 500;
            color: var(--text-color);
            margin-right: 12px;
        }
        
        .layer-name-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        .layer-name-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .layer-name-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .layer-name-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .layer-name-cancel {
            background-color: #f3f4f6;
            color: #374151;
        }
        
        .layer-name-cancel:hover {
            background-color: #e5e7eb;
        }
        
        .layer-name-save {
            background-color: #10b981;
            color: white;
        }
        
        .layer-name-save:hover {
            background-color: #059669;
        }
        
        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        .theme-toggle:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .theme-icon {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        .theme-toggle:hover .theme-icon {
            transform: rotate(180deg);
        }

        /* WiFiä¸‹æ‹‰æ¡†æ ·å¼ */
        .custom-select {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .select-selected {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            transition: all 0.2s;
        }
        
        .select-selected:hover {
            border-color: var(--primary-color);
        }
        
        .select-items {
            position: absolute;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            display: none; /* åˆå§‹éšè— */
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .select-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        
        .select-item:hover {
            background-color: var(--hover-bg);
        }
        
        .select-item:last-child {
            border-bottom: none;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 1.5rem;
            }
            
            .btn-group .btn {
                min-width: auto;
            }
            
            .keymap-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .layer-name-content {
                width: 95%;
                padding: 16px;
            }
            
            .layer-name-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .layer-name-label {
                min-width: auto;
                margin-right: 0;
                margin-bottom: 8px;
            }
            
            .theme-toggle {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .toast-container {
                top: 60px;
                right: 10px;
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <div class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
        <span class="theme-icon">ğŸŒ“</span>
        <span class="theme-text">ä¸»é¢˜</span>
    </div>
    
    <div class="container">
        <h1>ESP32è®¾å¤‡é…ç½®</h1>
        <p>å½“å‰çš„IPï¼š<span id="currentIP"></span></p>
        
        <!-- ä¸»æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('wifi')">WiFié…ç½®</div>
            <div class="tab" onclick="switchTab('keymap')">é”®ç›˜æ˜ å°„</div>
        </div>
        
        <!-- WiFié…ç½®å†…å®¹ -->
        <div id="wifi-content" class="tab-content active">
            <div class="wifi-section">
                <h2>æ‰«æåˆ°çš„WiFiåˆ—è¡¨</h2>
                <!-- è‡ªå®šä¹‰WiFiä¸‹æ‹‰èœå• -->
                <div class="custom-select">
                    <div id="wifiDropdown" class="select-selected">
                        è¯·é€‰æ‹©WiFi
                    </div>
                    <div id="wifiOptions" class="select-items">
                        <div class="select-item" data-value="">
                            è¯·é€‰æ‹©WiFi
                        </div>
                    </div>
                </div>
                <input type="hidden" id="selectedWifi" value="">
                <div class="password-input">
                    <input type="password" id="wifiPassword" placeholder="è¾“å…¥WiFiå¯†ç " class="form-element">
                </div>
                <button id="connectBtn" class="btn btn-primary">è¿æ¥WiFi</button>
            </div>
        </div>
        
        <!-- é”®ç›˜æ˜ å°„å†…å®¹ -->
        <div id="keymap-content" class="tab-content">
            <div class="keymap-section">
                <!-- é”®ç›˜æ˜ å°„æ ‡ç­¾é¡µ -->
                <div class="keymap-tabs">
                    <div class="keymap-tab active" onclick="switchKeymapTab('default')">é»˜è®¤æ˜ å°„ï¼ˆåªè¯»ï¼‰</div>
                    <!-- è‡ªå®šä¹‰å±‚é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                <div class="custom-select" style="display: inline-block; margin-left: 10px;">
                    <div id="customLayerDropdown" class="select-selected">
                        é€‰æ‹©è‡ªå®šä¹‰å±‚
                    </div>
                    <div id="customLayerOptions" class="select-items">
                        <div class="select-item" data-value="custom1" onclick="selectCustomLayer(this)">è‡ªå®šä¹‰å±‚1</div>
                        <div class="select-item" data-value="custom2" onclick="selectCustomLayer(this)">è‡ªå®šä¹‰å±‚2</div>
                        <div class="select-item" data-value="custom3" onclick="selectCustomLayer(this)">è‡ªå®šä¹‰å±‚3</div>
                        <div class="select-item" data-value="custom4" onclick="selectCustomLayer(this)">è‡ªå®šä¹‰å±‚4</div>
                        <div class="select-item" data-value="custom5" onclick="selectCustomLayer(this)">è‡ªå®šä¹‰å±‚5</div>
                        <div class="select-item" data-value="custom6" onclick="selectCustomLayer(this)">è‡ªå®šä¹‰å±‚6</div>
                        <div class="select-item" onclick="editLayerNames()" style="border-top: 1px solid var(--border-color); background-color: var(--secondary-bg); font-weight: 500;">
                            âœï¸ ç¼–è¾‘å±‚åç§°
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- æŒ‰é”®åˆ†ç»„ä¸‹æ‹‰èœå• -->
                <div class="key-group-selector" style="margin: 10px 0;">
                    <label for="keyGroupSelect" style="font-weight: 500; margin-right: 8px;">æŒ‰é”®åˆ†ç»„ï¼š</label>
                    <select id="keyGroupSelect" class="form-element" onchange="filterKeysByGroup()" style="width: 200px;">
                        <option value="å…¨éƒ¨æŒ‰é”®">å…¨éƒ¨æŒ‰é”®</option>
                        <option value="å­—æ¯é”®">å­—æ¯é”®</option>
                        <option value="æ•°å­—é”®">æ•°å­—é”®</option>
                        <option value="åŠŸèƒ½é”®">åŠŸèƒ½é”®</option>
                        <option value="æ–¹å‘é”®">æ–¹å‘é”®</option>
                        <option value="æ§åˆ¶é”®">æ§åˆ¶é”®</option>
                        <option value="ç‰¹æ®Šé”®">ç‰¹æ®Šé”®</option>
                        <option value="å¤šåª’ä½“é”®">å¤šåª’ä½“é”®</option>
                        <option value="å…¶ä»–é”®">å…¶ä»–é”®</option>
                        <option value="ç»„åˆé”®">ç»„åˆé”®</option>
                    </select>
                </div>
                
                <!-- çŠ¶æ€æ¶ˆæ¯ -->
                <div id="keymapStatus" class="keymap-status" style="display: none;"></div>
                
                <!-- é»˜è®¤é”®ç›˜æ˜ å°„ -->
                <div id="default-keymap" class="keymap-content active">
                    <div class="keymap-grid" id="defaultKeymapGrid"></div>
                    <p>ä»¥ä¸Šæ˜¯é»˜è®¤çš„æŒ‰é”®æ˜ å°„é…ç½®ï¼Œæ— æ³•ä¿®æ”¹ã€‚æ‚¨å¯ä»¥åœ¨è‡ªå®šä¹‰å±‚æ ‡ç­¾ä¸­åˆ›å»ºè‡ªå·±çš„æŒ‰é”®é…ç½®ã€‚</p>
                </div>
                
                <div id="custom1-keymap" class="keymap-content"><div class="keymap-grid" id="customKeymapGrid1"></div><div class="btn-group"><button id="loadKeymapBtn1" class="btn btn-secondary" onclick="loadCustomKeymap(1)">åŠ è½½é…ç½®</button><button id="saveKeymapBtn1" class="btn btn-primary" onclick="saveCustomKeymap(1)">ä¿å­˜é…ç½®</button><button id="resetKeymapBtn1" class="btn btn-warning" onclick="resetCustomKeymap(1)">é‡ç½®ä¸ºç©º</button></div></div>
                 <div id="custom2-keymap" class="keymap-content"><div class="keymap-grid" id="customKeymapGrid2"></div><div class="btn-group"><button id="loadKeymapBtn2" class="btn btn-secondary" onclick="loadCustomKeymap(2)">åŠ è½½é…ç½®</button><button id="saveKeymapBtn2" class="btn btn-primary" onclick="saveCustomKeymap(2)">ä¿å­˜é…ç½®</button><button id="resetKeymapBtn2" class="btn btn-warning" onclick="resetCustomKeymap(2)">é‡ç½®ä¸ºç©º</button></div></div>
                 <div id="custom3-keymap" class="keymap-content"><div class="keymap-grid" id="customKeymapGrid3"></div><div class="btn-group"><button id="loadKeymapBtn3" class="btn btn-secondary" onclick="loadCustomKeymap(3)">åŠ è½½é…ç½®</button><button id="saveKeymapBtn3" class="btn btn-primary" onclick="saveCustomKeymap(3)">ä¿å­˜é…ç½®</button><button id="resetKeymapBtn3" class="btn btn-warning" onclick="resetCustomKeymap(3)">é‡ç½®ä¸ºç©º</button></div></div>
                 <div id="custom4-keymap" class="keymap-content"><div class="keymap-grid" id="customKeymapGrid4"></div><div class="btn-group"><button id="loadKeymapBtn4" class="btn btn-secondary" onclick="loadCustomKeymap(4)">åŠ è½½é…ç½®</button><button id="saveKeymapBtn4" class="btn btn-primary" onclick="saveCustomKeymap(4)">ä¿å­˜é…ç½®</button><button id="resetKeymapBtn4" class="btn btn-warning" onclick="resetCustomKeymap(4)">é‡ç½®ä¸ºç©º</button></div></div>
                 <div id="custom5-keymap" class="keymap-content"><div class="keymap-grid" id="customKeymapGrid5"></div><div class="btn-group"><button id="loadKeymapBtn5" class="btn btn-secondary" onclick="loadCustomKeymap(5)">åŠ è½½é…ç½®</button><button id="saveKeymapBtn5" class="btn btn-primary" onclick="saveCustomKeymap(5)">ä¿å­˜é…ç½®</button><button id="resetKeymapBtn5" class="btn btn-warning" onclick="resetCustomKeymap(5)">é‡ç½®ä¸ºç©º</button></div></div>
                 <div id="custom6-keymap" class="keymap-content"><div class="keymap-grid" id="customKeymapGrid6"></div><div class="btn-group"><button id="loadKeymapBtn6" class="btn btn-secondary" onclick="loadCustomKeymap(6)">åŠ è½½é…ç½®</button><button id="saveKeymapBtn6" class="btn btn-primary" onclick="saveCustomKeymap(6)">ä¿å­˜é…ç½®</button><button id="resetKeymapBtn6" class="btn btn-warning" onclick="resetCustomKeymap(6)">é‡ç½®ä¸ºç©º</button></div></div>
            </div>
        </div>
        
        <p>å½“å‰æ—¶é—´ï¼š<span id="currentTime"></span></p>
    </div>
    
    <!-- å±‚åç§°ç¼–è¾‘å¯¹è¯æ¡† -->
    <div id="layerNameModal" class="layer-name-modal">
        <div class="layer-name-content">
            <div class="layer-name-header">
                <h3 class="layer-name-title">ç¼–è¾‘è‡ªå®šä¹‰å±‚åç§°</h3>
                <button class="layer-name-close" onclick="closeLayerNameModal()">Ã—</button>
            </div>
            
            <div id="layerNameItems">
                <!-- å±‚åç§°è¾“å…¥é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="layer-name-info">
                <p style="font-size: 12px; color: #666; margin: 10px 0; padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                    ğŸ’¡ æç¤ºï¼šä¿å­˜çš„å±‚åç§°å­˜å‚¨åœ¨æµè§ˆå™¨ç¼“å­˜ä¸­ï¼Œæ¸…ç†æµè§ˆå™¨ç¼“å­˜ååç§°å°†æ¢å¤ä¸ºé»˜è®¤å€¼ã€‚
                </p>
            </div>
            
            <div class="layer-name-actions">
                <button class="layer-name-btn layer-name-cancel" onclick="closeLayerNameModal()">å–æ¶ˆ</button>
                <button class="layer-name-btn layer-name-save" onclick="saveLayerNames()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡ï¼šæŒ‰é”®æ•°é‡ï¼ˆé»˜è®¤ä¸º0ï¼Œç­‰å¾…ä»åç«¯è·å–ï¼‰
        let numKeys = 0;
        
        // è·å–æŒ‰é”®æ•°é‡é…ç½®
        async function fetchNumKeys() {
            try {
                // å®é™…è°ƒç”¨åç«¯APIè·å–æŒ‰é”®æ•°é‡
                const response = await fetch('/get-num-keys');
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        numKeys = data.numKeys;
                        console.log('ä»åç«¯è·å–æŒ‰é”®æ•°é‡:', numKeys);
                    } else {
                        throw new Error(data.message || 'è·å–æŒ‰é”®æ•°é‡å¤±è´¥');
                    }
                } else {
                    throw new Error('HTTPé”™è¯¯: ' + response.status);
                }
            } catch (error) {
                // å¦‚æœåç«¯APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼17
                console.log('è·å–æŒ‰é”®æ•°é‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼17:', error);
                numKeys = 17;
            }
            
            // è®¾ç½®å…¨å±€å˜é‡
            window.numKeys = numKeys;
        }
        
        // ä¸»æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰å†…å®¹
            document.getElementById('wifi-content').classList.remove('active');
            document.getElementById('keymap-content').classList.remove('active');
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹
            document.getElementById(tabName + '-content').classList.add('active');
            
            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾
            document.querySelector('.tab[onclick="switchTab(\'' + tabName + '\')"]').classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°é”®ç›˜æ˜ å°„æ ‡ç­¾ï¼ŒåŠ è½½é»˜è®¤æ˜ å°„å¹¶éšè—æŒ‰é”®åˆ†ç»„
            if (tabName === 'keymap') {
                loadDefaultKeymap();
                // éšè—æŒ‰é”®åˆ†ç»„ä¸‹æ‹‰èœå•
                const keyGroupSelector = document.querySelector('.key-group-selector');
                if (keyGroupSelector) {
                    keyGroupSelector.style.display = 'none';
                }
            }
        }
        
        // é”®ç›˜æ˜ å°„æ ‡ç­¾é¡µåˆ‡æ¢
        function switchKeymapTab(tabName) {
            // å®‰å…¨åœ°ç§»é™¤activeç±»
            const defaultKeymap = document.getElementById('default-keymap');
            if (defaultKeymap) defaultKeymap.classList.remove('active');
            
            [1,2,3,4,5,6].forEach(i => {
                const customKeymap = document.getElementById('custom' + i + '-keymap');
                if (customKeymap) customKeymap.classList.remove('active');
            });
            
            document.querySelectorAll('.keymap-tab').forEach(tab => tab.classList.remove('active'));
            
            // å®‰å…¨åœ°æ·»åŠ activeç±»
            const targetKeymap = document.getElementById(tabName + '-keymap');
            if (targetKeymap) targetKeymap.classList.add('active');
            
            const targetTab = document.querySelector('.keymap-tab[onclick="switchKeymapTab(\'' + tabName + '\')"]');
            if (targetTab) targetTab.classList.add('active');
            
            // æ§åˆ¶æŒ‰é”®åˆ†ç»„ä¸‹æ‹‰èœå•çš„æ˜¾ç¤º/éšè—
            const keyGroupSelector = document.querySelector('.key-group-selector');
            if (keyGroupSelector) {
                if (tabName === 'default') {
                    keyGroupSelector.style.display = 'none';
                } else {
                    keyGroupSelector.style.display = 'block';
                }
            }
            
            if (tabName.startsWith('custom')) loadCustomKeymap(parseInt(tabName.replace('custom', '')));
        }
        
        function selectCustomLayer(element) {
            const value = element.getAttribute('data-value');
            const displayName = getLayerDisplayName(value);
            document.getElementById('customLayerDropdown').textContent = displayName;
            document.getElementById('customLayerOptions').style.display = 'none';
            
            switchKeymapTab(value);
        }
        
        function showStatus(message, type = 'success') {
            const statusElement = document.getElementById('keymapStatus');
            statusElement.textContent = message;
            
            statusElement.classList.remove('status-success', 'status-error', 'status-warning');
            
            statusElement.classList.add('status-' + type);
            
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }
        
        const KEY_COMBO_FLAG = 0x7000;
        const KEY_MODIFIER_MASK = 0x0F00;
        const KEY_BASE_MASK = 0x00FF;
                
        const MOD_LCTRL = 0x0100;
        const MOD_LSHIFT = 0x0200;
        const MOD_LALT = 0x0400;
        const MOD_LGUI = 0x0800;

        const modifierNames = {
            [MOD_LCTRL]: 'Ctrl',
            [MOD_LSHIFT]: 'Shift',
            [MOD_LALT]: 'Alt',
            [MOD_LGUI]: 'Win'

        };
        
        const keyCodeMap = {
            0x0000: 'KC_NO',
            0x0001: 'KC_TRANSPARENT',
            0x0004: 'KC_A',
            0x0005: 'KC_B',
            0x0006: 'KC_C',
            0x0007: 'KC_D',
            0x0008: 'KC_E',
            0x0009: 'KC_F',
            0x000A: 'KC_G',
            0x000B: 'KC_H',
            0x000C: 'KC_I',
            0x000D: 'KC_J',
            0x000E: 'KC_K',
            0x000F: 'KC_L',
            0x0010: 'KC_M',
            0x0011: 'KC_N',
            0x0012: 'KC_O',
            0x0013: 'KC_P',
            0x0014: 'KC_Q',
            0x0015: 'KC_R',
            0x0016: 'KC_S',
            0x0017: 'KC_T',
            0x0018: 'KC_U',
            0x0019: 'KC_V',
            0x001A: 'KC_W',
            0x001B: 'KC_X',
            0x001C: 'KC_Y',
            0x001D: 'KC_Z',
            0x001E: 'KC_1',
            0x001F: 'KC_2',
            0x0020: 'KC_3',
            0x0021: 'KC_4',
            0x0022: 'KC_5',
            0x0023: 'KC_6',
            0x0024: 'KC_7',
            0x0025: 'KC_8',
            0x0026: 'KC_9',
            0x0027: 'KC_0',
            0x0028: 'KC_ENTER',
            0x0029: 'KC_ESCAPE',
            0x002A: 'KC_BACKSPACE',
            0x002B: 'KC_TAB',
            0x002C: 'KC_SPACE',
            0x002D: 'KC_MINUS',
            0x002E: 'KC_EQUAL',
            0x002F: 'KC_LEFT_BRACKET',
            0x0030: 'KC_RIGHT_BRACKET',
            0x0031: 'KC_BACKSLASH',
            0x0032: 'KC_NONUS_HASH',
            0x0033: 'KC_SEMICOLON',
            0x0034: 'KC_QUOTE',
            0x0035: 'KC_GRAVE',
            0x0036: 'KC_COMMA',
            0x0037: 'KC_DOT',
            0x0038: 'KC_SLASH',
            0x0039: 'KC_CAPS_LOCK',
            0x003A: 'KC_F1',
            0x003B: 'KC_F2',
            0x003C: 'KC_F3',
            0x003D: 'KC_F4',
            0x003E: 'KC_F5',
            0x003F: 'KC_F6',
            0x0040: 'KC_F7',
            0x0041: 'KC_F8',
            0x0042: 'KC_F9',
            0x0043: 'KC_F10',
            0x0044: 'KC_F11',
            0x0045: 'KC_F12',
            0x0049: 'KC_INSERT',
            0x004A: 'KC_HOME',
            0x004B: 'KC_PAGE_UP',
            0x004C: 'KC_DELETE',
            0x004D: 'KC_END',
            0x004E: 'KC_PAGE_DOWN',
            0x004F: 'KC_RIGHT',
            0x0050: 'KC_LEFT',
            0x0051: 'KC_DOWN',
            0x0052: 'KC_UP',
            0x0053: 'KC_NUM_LOCK',
            0x0054: 'KC_KP_SLASH',
            0x0055: 'KC_KP_ASTERISK',
            0x0056: 'KC_KP_MINUS',
            0x0057: 'KC_KP_PLUS',
            0x0058: 'KC_KP_ENTER',
            0x0059: 'KC_KP_1',
            0x005A: 'KC_KP_2',
            0x005B: 'KC_KP_3',
            0x005C: 'KC_KP_4',
            0x005D: 'KC_KP_5',
            0x005E: 'KC_KP_6',
            0x005F: 'KC_KP_7',
            0x0060: 'KC_KP_8',
            0x0061: 'KC_KP_9',
            0x0062: 'KC_KP_0',
            0x0063: 'KC_KP_DOT',
            // å¤šåª’ä½“æŒ‰é”®
            0x00A8: 'é™éŸ³',
            0x00A9: 'éŸ³é‡+',
            0x00AA: 'éŸ³é‡-',
            0x00AB: 'ä¸‹ä¸€æ›²',
            0x00AC: 'ä¸Šä¸€æ›²',
            0x00AE: 'æ’­æ”¾/æš‚åœ',
            0x00B1: 'é‚®ä»¶',
            0x00B2: 'è®¡ç®—å™¨',
            0x00B3: 'æˆ‘çš„ç”µè„‘',
            0x00B4: 'ç½‘é¡µæœç´¢',
            0x00B5: 'ä¸»é¡µ',
            0x00B6: 'åé€€',
            0x00B7: 'å‰è¿›',
            0x00B8: 'åœæ­¢',
            0x00B9: 'åˆ·æ–°',
            0x00BA: 'æ”¶è—å¤¹',
            0x00BB: 'åª’ä½“å¿«è¿›',
            0x00BC: 'åª’ä½“å¿«é€€',
            0x00BD: 'äº®åº¦+',
            0x00BE: 'äº®åº¦-',
            // æ ‡å‡†æ§åˆ¶é”® (ä¿®é¥°é”®)
            0x00E0: 'KC_LEFT_CTRL',
            0x00E1: 'KC_LEFT_SHIFT',
            0x00E2: 'KC_LEFT_ALT',
            0x00E3: 'KC_LEFT_GUI',
            0x00E4: 'KC_RIGHT_CTRL',
            0x00E5: 'KC_RIGHT_SHIFT',
            0x00E6: 'KC_RIGHT_ALT',
            0x00E7: 'KC_RIGHT_GUI',
            // æ‰©å±•ä¿®é¥°é”®
            0x0100: 'KC_LCTRL',
            0x0200: 'KC_LSHIFT',
            0x0400: 'KC_LALT',
            0x0800: 'KC_LGUI'
        };
        
        function isComboKey(code) {
            const isCombo = (code & KEY_COMBO_FLAG) === KEY_COMBO_FLAG;
            return isCombo;
        }
        
        function getBaseKey(code) {
            return code & KEY_BASE_MASK;
        }
        
        function getModifierMask(code) {
            const modifierMask = code & KEY_MODIFIER_MASK;
            return modifierMask;
        }
        
        function createComboKey(baseKey, modifierMask) {
            const comboKey = KEY_COMBO_FLAG | modifierMask | (baseKey & KEY_BASE_MASK);
            return comboKey;
        }
        
        function getModifierNames(modifierMask) {
            const modifiers = [];
            
            for (const [mask, name] of Object.entries(modifierNames)) {
                const maskValue = parseInt(mask);
                const hasModifier = (modifierMask & maskValue) !== 0;
                
                if (hasModifier) {
                    modifiers.push(name);
                }
            }
            
            return modifiers;
        }
        
        function getKeyName(code) {
            if (isComboKey(code)) {
                const baseKey = getBaseKey(code);
                const modifierMask = getModifierMask(code);
                const modifiers = getModifierNames(modifierMask);
                const baseName = keyCodeMap[baseKey] || `æœªçŸ¥(0x${baseKey.toString(16).toUpperCase().padStart(4, '0')})`;
                
                if (modifiers.length > 0) {
                    return `${modifiers.join('+')}+${baseName}`;
                } else {
                    return baseName;
                }
            } else {
                return keyCodeMap[code] || `æœªçŸ¥(0x${code.toString(16).toUpperCase().padStart(4, '0')})`;
            }
        }
        
        function getNormalKeyOptions(selectedCode = 0) {
            let options = `<option value="0" ${selectedCode === 0 ? 'selected' : ''}>ç©ºï¼ˆæ— åŠŸèƒ½ï¼‰</option>`;
            Object.keys(keyCodeMap).map(Number).sort((a, b) => a - b).forEach(code => {
                if (!isComboKey(code)) {
                    options += `<option value="${code}" ${selectedCode === code ? 'selected' : ''}>${getKeyName(code)}</option>`;
                }
            });
            return options;
        }
        
        function getComboKeyOptions(selectedCode = 0) {
            const isCustomSelected = selectedCode === 'custom';
            const numericSelectedCode = isCustomSelected ? 0 : selectedCode;
            let options = `<option value="0" ${numericSelectedCode === 0 ? 'selected' : ''}>ç©ºï¼ˆæ— åŠŸèƒ½ï¼‰</option>`;
            const commonCombos = [0x0004,0x0006,0x0007,0x0010,0x0016,0x0017,0x0018,0x001A,0x001B,0x001C,0x001D,0x003A,0x003B,0x003C,0x003D,0x003E,0x003F,0x0040,0x0041,0x0042,0x0043,0x0044,0x0045].flatMap(key => [
                createComboKey(key, MOD_LCTRL), createComboKey(key, MOD_LALT), createComboKey(key, MOD_LSHIFT), createComboKey(key, MOD_LGUI),
                createComboKey(key, MOD_LCTRL | MOD_LSHIFT), createComboKey(key, MOD_LCTRL | MOD_LALT)
            ]);
            commonCombos.forEach(comboKey => {
                options += `<option value="${comboKey}" ${numericSelectedCode === comboKey ? 'selected' : ''}>${getKeyName(comboKey)}</option>`;
            });
            options += `<option value="custom" ${isCustomSelected ? 'selected' : ''}>è‡ªå®šä¹‰ç»„åˆé”®...</option>`;
            if (numericSelectedCode !== 0 && !isCustomSelected && !isComboKey(numericSelectedCode)) {
                options += `<option value="${numericSelectedCode}" selected>${getKeyName(numericSelectedCode)}</option>`;
            }
            return options;
        }
        
        // åˆå¹¶æ™®é€šé”®å’Œç»„åˆé”®çš„é€‰é¡¹ï¼Œå¹¶æ ¹æ®å½“å‰åˆ†ç»„è¿‡æ»¤
        function getMergedKeyOptions(selectedCode = 0) {
            const isCustomSelected = selectedCode === 'custom';
            const numericSelectedCode = isCustomSelected ? 0 : selectedCode;
            let options = `<option value="0" ${numericSelectedCode === 0 ? 'selected' : ''}>ç©ºï¼ˆæ— åŠŸèƒ½ï¼‰</option>`;
            
            // è·å–å½“å‰é€‰ä¸­çš„åˆ†ç»„
            const groupSelect = document.getElementById('keyGroupSelect');
            const selectedGroup = groupSelect ? groupSelect.value : 'å…¨éƒ¨æŒ‰é”®';
            
            // æ™®é€šé”®åˆ†ç»„
            const normalKeys = Object.keys(keyCodeMap).map(Number).sort((a, b) => a - b).filter(code => !isComboKey(code));
            
            // ç»„åˆé”®åˆ†ç»„
            const commonCombos = [0x0004,0x0006,0x0007,0x0010,0x0016,0x0017,0x0018,0x001A,0x001B,0x001C,0x001D,0x003A,0x003B,0x003C,0x003D,0x003E,0x003F,0x0040,0x0041,0x0042,0x0043,0x0044,0x0045].flatMap(key => [
                createComboKey(key, MOD_LCTRL), createComboKey(key, MOD_LALT), createComboKey(key, MOD_LSHIFT), createComboKey(key, MOD_LGUI),
                createComboKey(key, MOD_LCTRL | MOD_LSHIFT), createComboKey(key, MOD_LCTRL | MOD_LALT)
            ]);
            
            // æ ¹æ®å½“å‰é€‰ä¸­çš„åˆ†ç»„è¿‡æ»¤é€‰é¡¹
            if (selectedGroup === 'å…¨éƒ¨æŒ‰é”®' || selectedGroup === 'æ™®é€šé”®') {
                // æ·»åŠ æ™®é€šé”®é€‰é¡¹ï¼ˆæŒ‰åˆ†ç»„ï¼‰
                options += '<optgroup label="æ™®é€šé”®">';
                normalKeys.forEach(code => {
                    if (selectedGroup === 'å…¨éƒ¨æŒ‰é”®' || getKeyGroup(code) === selectedGroup) {
                        options += `<option value="${code}" ${numericSelectedCode === code ? 'selected' : ''}>${getKeyName(code)}</option>`;
                    }
                });
                options += '</optgroup>';
            }
            
            if (selectedGroup === 'å…¨éƒ¨æŒ‰é”®' || selectedGroup === 'ç»„åˆé”®') {
                // æ·»åŠ ç»„åˆé”®é€‰é¡¹ï¼ˆæŒ‰ä¿®é¥°é”®åˆ†ç»„ï¼‰
                options += '<optgroup label="Ctrlç»„åˆé”®">';
                commonCombos.filter(comboKey => (getModifierMask(comboKey) & MOD_LCTRL) && !(getModifierMask(comboKey) & MOD_LSHIFT) && !(getModifierMask(comboKey) & MOD_LALT) && !(getModifierMask(comboKey) & MOD_LGUI)).forEach(comboKey => {
                    options += `<option value="${comboKey}" ${numericSelectedCode === comboKey ? 'selected' : ''}>${getKeyName(comboKey)}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="Shiftç»„åˆé”®">';
                commonCombos.filter(comboKey => (getModifierMask(comboKey) & MOD_LSHIFT) && !(getModifierMask(comboKey) & MOD_LCTRL) && !(getModifierMask(comboKey) & MOD_LALT) && !(getModifierMask(comboKey) & MOD_LGUI)).forEach(comboKey => {
                    options += `<option value="${comboKey}" ${numericSelectedCode === comboKey ? 'selected' : ''}>${getKeyName(comboKey)}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="Altç»„åˆé”®">';
                commonCombos.filter(comboKey => (getModifierMask(comboKey) & MOD_LALT) && !(getModifierMask(comboKey) & MOD_LCTRL) && !(getModifierMask(comboKey) & MOD_LSHIFT) && !(getModifierMask(comboKey) & MOD_LGUI)).forEach(comboKey => {
                    options += `<option value="${comboKey}" ${numericSelectedCode === comboKey ? 'selected' : ''}>${getKeyName(comboKey)}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="Winç»„åˆé”®">';
                commonCombos.filter(comboKey => (getModifierMask(comboKey) & MOD_LGUI) && !(getModifierMask(comboKey) & MOD_LCTRL) && !(getModifierMask(comboKey) & MOD_LSHIFT) && !(getModifierMask(comboKey) & MOD_LALT)).forEach(comboKey => {
                    options += `<option value="${comboKey}" ${numericSelectedCode === comboKey ? 'selected' : ''}>${getKeyName(comboKey)}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="å¤šä¿®é¥°é”®ç»„åˆ">';
                commonCombos.filter(comboKey => {
                    const mask = getModifierMask(comboKey);
                    return (mask & MOD_LCTRL && mask & MOD_LSHIFT) || (mask & MOD_LCTRL && mask & MOD_LALT);
                }).forEach(comboKey => {
                    options += `<option value="${comboKey}" ${numericSelectedCode === comboKey ? 'selected' : ''}>${getKeyName(comboKey)}</option>`;
                });
                options += '</optgroup>';
            }
            
            // å¯¹äºç‰¹å®šåˆ†ç»„ï¼ˆå­—æ¯é”®ã€æ•°å­—é”®ã€åŠŸèƒ½é”®ç­‰ï¼‰ï¼Œåªæ˜¾ç¤ºå±äºè¯¥åˆ†ç»„çš„æŒ‰é”®
            if (selectedGroup !== 'å…¨éƒ¨æŒ‰é”®' && selectedGroup !== 'æ™®é€šé”®' && selectedGroup !== 'ç»„åˆé”®') {
                options += '<optgroup label="' + selectedGroup + '">';
                
                // æ™®é€šé”®ä¸­å±äºå½“å‰åˆ†ç»„çš„æŒ‰é”®
                normalKeys.forEach(code => {
                    if (getKeyGroup(code) === selectedGroup) {
                        options += `<option value="${code}" ${numericSelectedCode === code ? 'selected' : ''}>${getKeyName(code)}</option>`;
                    }
                });
                
                // ç»„åˆé”®ä¸­å±äºå½“å‰åˆ†ç»„çš„æŒ‰é”®
                commonCombos.forEach(comboKey => {
                    if (getKeyGroup(comboKey) === selectedGroup) {
                        options += `<option value="${comboKey}" ${numericSelectedCode === comboKey ? 'selected' : ''}>${getKeyName(comboKey)}</option>`;
                    }
                });
                
                options += '</optgroup>';
            }
            
            // æ·»åŠ è‡ªå®šä¹‰ç»„åˆé”®é€‰é¡¹ï¼ˆåªåœ¨ç»„åˆé”®åˆ†ç»„ä¸­æ˜¾ç¤ºï¼‰
            if (selectedGroup === 'å…¨éƒ¨æŒ‰é”®' || selectedGroup === 'ç»„åˆé”®') {
                options += `<option value="custom" ${isCustomSelected ? 'selected' : ''}>è‡ªå®šä¹‰ç»„åˆé”®...</option>`;
            }
            
            // åœ¨æ‰€æœ‰åˆ†ç»„ä¸­ï¼Œæ€»æ˜¯æ˜¾ç¤ºå½“å‰é€‰ä¸­å€¼çš„ä¸´æ—¶å€¼é€‰é¡¹ï¼ˆæ”¾åœ¨ç©ºé€‰é¡¹ä¸‹é¢ï¼‰
            if (numericSelectedCode !== 0 && !isCustomSelected) {
                // åœ¨ç©ºé€‰é¡¹åé¢æ’å…¥ä¸´æ—¶å€¼é€‰é¡¹
                const emptyOption = `<option value="0" ${numericSelectedCode === 0 ? 'selected' : ''}>ç©ºï¼ˆæ— åŠŸèƒ½ï¼‰</option>`;
                const tempOption = `<option value="${numericSelectedCode}" selected>${getKeyName(numericSelectedCode)}</option>`;
                
                // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ›¿æ¢æ–¹æ³•ï¼Œç¡®ä¿åªæ›¿æ¢ç©ºé€‰é¡¹
                const emptyOptionIndex = options.indexOf(emptyOption);
                if (emptyOptionIndex !== -1) {
                    // åœ¨ç©ºé€‰é¡¹åé¢æ’å…¥ä¸´æ—¶å€¼é€‰é¡¹
                    options = options.substring(0, emptyOptionIndex + emptyOption.length) + 
                             tempOption + 
                             options.substring(emptyOptionIndex + emptyOption.length);
                }
            }
            
            return options;
        }
        

        
        function getDefaultKeymaps(numKeys = 17) {
            const baseMap0 = [0x0029, 0x0054, 0x0055, 0x0056, 0x005F, 0x0060, 0x0061, 0x0057, 0x005C, 0x005D, 0x005E, 0x0059, 0x005A, 0x005B, 0x0062, 0x0063, 0x0058];
            const baseMap1 = [0x0029, 0x0054, 0x0055, 0x002A, 0x0014, 0x001A, 0x0008, 0x0057, 0x0004, 0x0016, 0x0007, 0x0059, 0x005A, 0x005B, 0x0062, 0x0063, 0x0058];
            const extendMap = (baseMap, targetLength) => {
                const extended = [...baseMap];
                while (extended.length < targetLength) extended.push(0);
                return extended;
            };
            return {
                0: extendMap(baseMap0, numKeys), 1: extendMap(baseMap1, numKeys),
                2: Array(numKeys).fill(0), 3: Array(numKeys).fill(0),
                4: Array(numKeys).fill(0), 5: Array(numKeys).fill(0), 6: Array(numKeys).fill(0)
            };
        }
        
        // åŠ è½½é»˜è®¤é”®ç›˜æ˜ å°„
        function loadDefaultKeymap() {
            const grid = document.getElementById('defaultKeymapGrid');
            grid.innerHTML = '';
            
            // åŠ¨æ€è·å–æŒ‰é”®æ•°é‡ï¼ˆæ­£ç¡®å¤„ç†0å€¼ï¼‰
            const numKeys = window.numKeys !== undefined ? window.numKeys : 17;
            
            // è·å–åŠ¨æ€çš„é»˜è®¤æ˜ å°„
            const defaultKeymaps = getDefaultKeymaps(numKeys);
            
            // æ˜¾ç¤ºé»˜è®¤æ˜ å°„ï¼ˆå±‚0ï¼‰
            defaultKeymaps[0].forEach((code, index) => {
                const keyItem = document.createElement('div');
                keyItem.className = 'key-item readonly';
                keyItem.innerHTML = `
                    <div class="key-number">æŒ‰é”® ${index + 1}</div>
                    <div class="key-value">${getKeyName(code)}</div>
                `;
                grid.appendChild(keyItem);
            });
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŠ è½½è‡ªå®šä¹‰æ˜ å°„ï¼Œåˆå§‹åŒ–ä¸ºç©º
            const customGrid = document.getElementById('customKeymapGrid');
            if (customGrid && !customGrid.hasChildNodes()) {
                initCustomKeymap(1); // åˆå§‹åŒ–ç¬¬ä¸€å±‚è‡ªå®šä¹‰æ˜ å°„
            }
        }
        

        
        function handleComboKeyChange(select) {
            const value = select.value;
            
            if (value === 'custom') {
                showCustomComboEditor(select);
            }
        }
        
        function showCustomComboEditor(select) {
            const modal = document.createElement('div');
            modal.className = 'combo-editor-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const editor = document.createElement('div');
            editor.className = 'combo-editor';
            editor.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 1rem;
                max-width: 400px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            editor.innerHTML = `
                <h3>è‡ªå®šä¹‰ç»„åˆé”®</h3>
                <div style="margin: 1rem 0;">
                    <label>ä¿®é¥°é”®ï¼š</label><br>
                    <div style="margin: 0.5rem 0;">
                        <input type="checkbox" id="modCtrl" value="${MOD_LCTRL}"> Ctrl
                        <input type="checkbox" id="modShift" value="${MOD_LSHIFT}" style="margin-left: 1rem;"> Shift
                    </div>
                    <div style="margin: 0.5rem 0;">
                        <input type="checkbox" id="modAlt" value="${MOD_LALT}"> Alt
                        <input type="checkbox" id="modWin" value="${MOD_LGUI}" style="margin-left: 1rem;"> Win
                    </div>
                </div>
                <div style="margin: 1rem 0;">
                    <label>åŸºç¡€é”®ï¼š</label><br>
                    <select id="baseKeySelect" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0;">
                        ${getNormalKeyOptions(0).replace(/selected/g, '')}
                    </select>
                </div>
                <div style="margin: 1rem 0; padding: 1rem; background: #f0f0f0; border-radius: 0.5rem;">
                    <strong>é¢„è§ˆï¼š</strong>
                    <span id="comboPreview">ç©ºï¼ˆæ— åŠŸèƒ½ï¼‰</span>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button onclick="applyCustomCombo(this.parentElement.parentElement)" style="flex: 1; padding: 0.75rem; background: #2563eb; color: white; border: none; border-radius: 0.5rem;">åº”ç”¨</button>
                    <button onclick="closeCustomComboEditor(this.parentElement.parentElement.parentElement)" style="flex: 1; padding: 0.75rem; background: #64748b; color: white; border: none; border-radius: 0.5rem;">å–æ¶ˆ</button>
                </div>
            `;
            
            modal.appendChild(editor);
            document.body.appendChild(modal);
            
            modal.dataset.originalSelect = select.dataset.keyIndex;
            
            const updatePreview = () => {
                const baseKey = parseInt(document.getElementById('baseKeySelect').value);
                let modifierMask = 0;
                
                if (document.getElementById('modCtrl').checked) modifierMask |= MOD_LCTRL;
                if (document.getElementById('modShift').checked) modifierMask |= MOD_LSHIFT;
                if (document.getElementById('modAlt').checked) modifierMask |= MOD_LALT;
                if (document.getElementById('modWin').checked) modifierMask |= MOD_LGUI;
                
                if (baseKey === 0 && modifierMask === 0) {
                    document.getElementById('comboPreview').textContent = 'ç©ºï¼ˆæ— åŠŸèƒ½ï¼‰';
                } else if (baseKey === 0) {
                    document.getElementById('comboPreview').textContent = 'ä»…ä¿®é¥°é”®ï¼ˆæ— æ•ˆï¼‰';
                } else if (modifierMask === 0) {
                    document.getElementById('comboPreview').textContent = getKeyName(baseKey);
                } else {
                    const comboKey = createComboKey(baseKey, modifierMask);
                    document.getElementById('comboPreview').textContent = getKeyName(comboKey);
                }
            };
            
            document.getElementById('modCtrl').addEventListener('change', updatePreview);
            document.getElementById('modShift').addEventListener('change', updatePreview);
            document.getElementById('modAlt').addEventListener('change', updatePreview);
            document.getElementById('modWin').addEventListener('change', updatePreview);
            document.getElementById('baseKeySelect').addEventListener('change', updatePreview);
            
            updatePreview();
        }
        
        // åº”ç”¨è‡ªå®šä¹‰ç»„åˆé”®
        function applyCustomCombo(editor) {
            const baseKey = parseInt(document.getElementById('baseKeySelect').value);
            let modifierMask = 0;
            
            if (document.getElementById('modCtrl').checked) modifierMask |= MOD_LCTRL;
            if (document.getElementById('modShift').checked) modifierMask |= MOD_LSHIFT;
            if (document.getElementById('modAlt').checked) modifierMask |= MOD_LALT;
            if (document.getElementById('modWin').checked) modifierMask |= MOD_LGUI;
            
            if (baseKey === 0) {
                alert('è¯·é€‰æ‹©åŸºç¡€é”®ï¼');
                return;
            }
            
            const comboKey = createComboKey(baseKey, modifierMask);
            const modal = editor.parentElement.parentElement;
            const selectIndex = modal.dataset.originalSelect;
            const select = document.querySelector(`.key-select[data-key-index="${selectIndex}"]`);
            
            if (select) {
                // æ›´æ–°é€‰é¡¹ä»¥æ˜¾ç¤ºæ­£ç¡®çš„é€‰æ‹©ï¼Œä½†ä¿ç•™"è‡ªå®šä¹‰ç»„åˆé”®..."é€‰é¡¹
                select.innerHTML = getComboKeyOptions(comboKey);
                select.value = comboKey;
            }
            
            closeCustomComboEditor(modal);
        }
        
        // å…³é—­è‡ªå®šä¹‰ç»„åˆé”®ç¼–è¾‘å™¨
        function closeCustomComboEditor(modal) {
            if (modal && modal.parentElement) {
                modal.parentElement.removeChild(modal);
            }
        }
        
        // å¤„ç†æŒ‰é”®å˜åŒ–äº‹ä»¶
        function handleKeyChange(select) {
            const keyIndex = parseInt(select.dataset.keyIndex);
            const layer = parseInt(select.dataset.layer);
            const keyCode = select.value;
            
            // å¦‚æœæ˜¯è‡ªå®šä¹‰ç»„åˆé”®ï¼Œæ‰“å¼€ç¼–è¾‘å™¨
            if (keyCode === 'custom') {
                handleComboKeyChange(select);
            } else {
                // è‡ªåŠ¨ä¿å­˜å•ä¸ªæŒ‰é”®
                saveSingleKey(keyIndex, parseInt(keyCode), layer);
            }
        }
        
        // åˆå§‹åŒ–æŒ‡å®šå±‚è‡ªå®šä¹‰é”®ç›˜æ˜ å°„ä¸ºç©º
        function initCustomKeymap(layer) {
            const grid = document.getElementById('customKeymapGrid' + layer);
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // åŠ¨æ€è·å–æŒ‰é”®æ•°é‡ï¼ˆæ­£ç¡®å¤„ç†0å€¼ï¼‰
            const numKeys = window.numKeys !== undefined ? window.numKeys : 17;
            
            // åˆ›å»ºæŒ‰é”®é€‰æ‹©å™¨ï¼ˆæ ¹æ®NUM_KEYSçš„å€¼ï¼‰
            for (let i = 0; i < numKeys; i++) {
                const keyItem = document.createElement('div');
                keyItem.className = 'key-item';
                keyItem.dataset.keyIndex = i;
                keyItem.dataset.layer = layer;
                keyItem.innerHTML = `
                    <div class="key-number">æŒ‰é”® ${i + 1}</div>
                    <select class="key-select" data-key-index="${i}" data-layer="${layer}" onchange="handleKeyChange(this)">
                        ${getMergedKeyOptions(0)}
                    </select>
                `;
                grid.appendChild(keyItem);
            }
        }
        
        // å…¨å±€æŒ‰é”®æ˜ å°„å­˜å‚¨ï¼ˆç”¨äºè·Ÿè¸ªç”¨æˆ·ä¿®æ”¹ï¼‰
        const customKeymaps = {
            1: [],
            2: [],
            3: [],
            4: [],
            5: [],
            6: []
        };
        
        // åˆå§‹åŒ–æŒ‰é”®æ˜ å°„å­˜å‚¨ï¼ˆåœ¨è·å–æŒ‰é”®æ•°é‡åè°ƒç”¨ï¼‰
        function initCustomKeymapsStorage() {
            const numKeys = window.numKeys !== undefined ? window.numKeys : 17;
            for (let layer = 1; layer <= 6; layer++) {
                customKeymaps[layer] = Array(numKeys).fill(0);
            }
            console.log('åˆå§‹åŒ–æŒ‰é”®æ˜ å°„å­˜å‚¨ï¼ŒæŒ‰é”®æ•°é‡:', numKeys);
        }
        
        // åŠ è½½æŒ‡å®šå±‚è‡ªå®šä¹‰é”®ç›˜æ˜ å°„
        async function loadCustomKeymap(layer) {
            try {
                console.log('å¼€å§‹åŠ è½½è‡ªå®šä¹‰é”®ç›˜æ˜ å°„å±‚', layer, '...');
                
                // å¦‚æœè¯¥å±‚å°šæœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–
                const grid = document.getElementById('customKeymapGrid' + layer);
                if (!grid) {
                    console.error('æ‰¾ä¸åˆ°è‡ªå®šä¹‰é”®ç›˜æ˜ å°„ç½‘æ ¼å…ƒç´ : customKeymapGrid' + layer);
                    return;
                }
                if (!grid.hasChildNodes()) {
                    initCustomKeymap(layer);
                }
                
                // ç¡®ä¿customKeymapså·²æ­£ç¡®åˆå§‹åŒ–
                if (!customKeymaps[layer] || customKeymaps[layer].length === 0) {
                    initCustomKeymapsStorage();
                }
                
                // è°ƒç”¨åç«¯APIåŠ è½½æŒ‰é”®æ˜ å°„æ•°æ®
                const response = await fetch(`/load-keymap?layer=${layer}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('åŠ è½½å“åº”æ•°æ®:', data);
                
                if (data.status === 'success' && data.keymap) {
                    console.log('åŠ è½½çš„é”®ç æ•°æ®:', data.keymap);
                    
                    // æ›´æ–°å†…å­˜ä¸­çš„æŒ‰é”®æ˜ å°„æ•°æ®
                    if (customKeymaps[layer] && customKeymaps[layer].length === data.keymap.length) {
                        customKeymaps[layer] = data.keymap;
                    }
                    
                    const selects = grid.querySelectorAll('.key-select');
                    
                    // è®¾ç½®é€‰æ‹©å™¨çš„å€¼ï¼Œç¡®ä¿æ‰€æœ‰ç±»å‹çš„é”®ç éƒ½èƒ½æ­£ç¡®æ˜¾ç¤º
                    // æ³¨æ„ï¼šåŠ è½½æ—¶åªæ˜¾ç¤ºå·²ä¿å­˜çš„æŒ‰é”®ï¼Œæœªä¿å­˜çš„æŒ‰é”®ä¿æŒä¸º0ï¼ˆæ— åŠŸèƒ½ï¼‰
                    data.keymap.forEach((code, index) => {
                        if (selects[index]) {
                            // ç¡®ä¿ä»»ä½•æ¨¡å¼ä¸‹éƒ½èƒ½æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰ç±»å‹çš„é”®å€¼
                            selects[index].value = code;
                            
                            // å¦‚æœå½“å‰å€¼ä¸å­˜åœ¨äºé€‰é¡¹ä¸­ï¼Œæ·»åŠ å®ƒ
                            if (code !== 0 && !selects[index].querySelector(`option[value="${code}"]`)) {
                                const option = document.createElement('option');
                                option.value = code;
                                option.textContent = getKeyName(code);
                                option.selected = true;
                                selects[index].appendChild(option);
                            }
                            
                            console.log('è®¾ç½®é€‰æ‹©å™¨', index, 'å€¼ä¸º:', code, 'åç§°:', getKeyName(code), 'æ˜¯å¦ä¸ºç»„åˆé”®:', isComboKey(code));
                        }
                    });
                    
                    showStatus('å±‚' + layer + 'æŒ‰é”®æ˜ å°„åŠ è½½æˆåŠŸ', 'success');
                } else {
                    showStatus('åŠ è½½å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æŒ‰é”®æ˜ å°„å¤±è´¥:', error);
                showStatus('åŠ è½½è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        

        
        // ä¿å­˜æŒ‡å®šå±‚è‡ªå®šä¹‰é”®ç›˜æ˜ å°„
        async function saveCustomKeymap(layer) {
            try {
                const grid = document.getElementById('customKeymapGrid' + layer);
                const selects = grid.querySelectorAll('.key-select');
                const keymap = [];
                
                // ä¿å­˜æ‰€æœ‰æŒ‰é”®çš„å€¼ï¼ˆåŒ…æ‹¬é›¶å€¼ï¼‰ï¼Œä¿æŒç´¢å¼•å¯¹åº”å…³ç³»
                selects.forEach(select => {
                    const value = parseInt(select.value);
                    keymap.push(value);
                });
                
                console.log('ä¿å­˜çš„é”®ç æ•°æ®ï¼ˆæ‰€æœ‰æŒ‰é”®ï¼‰:', keymap);
                
                // è°ƒç”¨åç«¯APIä¿å­˜æ•´ä¸ªé”®ç›˜æ˜ å°„
                const response = await fetch('/save-keymap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keymap: keymap,
                        layer: layer
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showStatus('å±‚' + layer + 'æŒ‰é”®æ˜ å°„ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    showStatus('ä¿å­˜å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜æŒ‰é”®æ˜ å°„å¤±è´¥:', error);
                showStatus('ä¿å­˜è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // ä¿å­˜å•ä¸ªæŒ‰é”®æ˜ å°„
        async function saveSingleKey(keyIndex, keyCode, layer) {
            try {
                console.log('ä¿å­˜å•ä¸ªæŒ‰é”®:', {keyIndex, keyCode, layer});
                
                // ç¡®ä¿customKeymapså·²æ­£ç¡®åˆå§‹åŒ–
                if (!customKeymaps[layer] || customKeymaps[layer].length === 0) {
                    initCustomKeymapsStorage();
                }
                
                // å®é™…æ›´æ–°å…¨å±€æŒ‰é”®æ˜ å°„æ•°æ®
                if (customKeymaps[layer] && keyIndex >= 0 && keyIndex < customKeymaps[layer].length) {
                    customKeymaps[layer][keyIndex] = keyCode;
                    console.log('å®é™…æ›´æ–°æŒ‰é”®æ˜ å°„æ•°æ®: å±‚', layer, 'æŒ‰é”®', keyIndex, 'å€¼', keyCode);
                }
                
                // è°ƒç”¨åç«¯APIä¿å­˜å•ä¸ªæŒ‰é”®
                const response = await fetch('/save-single-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keyIndex: keyIndex,
                        keyCode: keyCode,
                        layer: layer
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log('å•ä¸ªæŒ‰é”®ä¿å­˜æˆåŠŸ:', keyIndex, keyCode, layer);
                    showStatus(`å±‚${layer} æŒ‰é”® ${keyIndex + 1} ä¿å­˜æˆåŠŸ`, 'success');
                } else {
                    console.error('å•ä¸ªæŒ‰é”®ä¿å­˜å¤±è´¥:', data.message);
                    showStatus(`å±‚${layer} æŒ‰é”® ${keyIndex + 1} ä¿å­˜å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜å•ä¸ªæŒ‰é”®å¤±è´¥:', error);
                showStatus(`å±‚${layer} æŒ‰é”® ${keyIndex + 1} ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•`, 'error');
            }
        }
        
        // é‡ç½®æŒ‡å®šå±‚è‡ªå®šä¹‰é”®ç›˜æ˜ å°„ä¸ºç©º
        function resetCustomKeymap(layer) {
            if (confirm('ç¡®å®šè¦å°†å±‚' + layer + 'è‡ªå®šä¹‰æ˜ å°„é‡ç½®ä¸ºç©ºå—ï¼Ÿ')) {
                const grid = document.getElementById('customKeymapGrid' + layer);
                const selects = grid.querySelectorAll('.key-select');
                
                selects.forEach(select => {
                    select.value = '0';
                });
                
                showStatus('å±‚' + layer + 'è‡ªå®šä¹‰æ˜ å°„å·²é‡ç½®ä¸ºç©º', 'warning');
            }
        }
        
        // çŠ¶æ€æç¤ºå‡½æ•°
        function showStatus(message, type = 'info') {
            // ç§»é™¤ç°æœ‰çš„çŠ¶æ€æç¤º
            const existingStatus = document.querySelector('.status-message');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            // åˆ›å»ºæ–°çš„çŠ¶æ€æç¤º
            const statusElement = document.createElement('div');
            statusElement.className = `status-message ${type}`;
            statusElement.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(statusElement);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (statusElement.parentNode) {
                    statusElement.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (statusElement.parentNode) {
                            statusElement.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }
        
        // WiFiç›¸å…³å‡½æ•°ï¼ˆä¼˜åŒ–ä¸ºç›´æ¥è¿æ¥ï¼‰
        async function connectWifi() {
            const ssid = document.getElementById('selectedWifi').value;
            const password = document.getElementById('wifiPassword').value;
            if (!ssid || !password) {
                showStatus('è¯·é€‰æ‹©WiFiå¹¶è¾“å…¥å¯†ç ', 'error');
                return;
            }
            
            try {
                // åœ¨æœ¬åœ°æµ‹è¯•ç¯å¢ƒä¸­æ¨¡æ‹Ÿè¿æ¥æˆåŠŸ
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
                    showStatus('æ­£åœ¨è¿æ¥åˆ°WiFiç½‘ç»œ...ï¼ˆæ¨¡æ‹Ÿï¼‰', 'warning');
                    
                    // æ·»åŠ å»¶è¿Ÿæ¨¡æ‹Ÿè¿æ¥è¿‡ç¨‹
                    setTimeout(() => {
                        showStatus('WiFiè¿æ¥æˆåŠŸï¼ï¼ˆæ¨¡æ‹Ÿï¼‰', 'success');
                        // è¿æ¥æˆåŠŸåç¦ç”¨è¾“å…¥é˜²æ­¢é‡å¤æäº¤
                        document.getElementById('wifiDropdown').style.backgroundColor = '';
                        document.getElementById('wifiDropdown').classList.add('readonly');
                        document.getElementById('wifiDropdown').style.cursor = 'not-allowed';
                        document.getElementById('wifiDropdown').removeEventListener('click', toggleDropdown);
                        document.getElementById('wifiPassword').disabled = true;
                        document.getElementById('connectBtn').disabled = true;
                        // æ›´æ–°IPåœ°å€æ˜¾ç¤º
                        document.getElementById('currentIP').textContent = '192.168.1.101 (æ¨¡æ‹Ÿ)';
                    }, 1500);
                    return;
                }
                
                // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
                showStatus('è®¾å¤‡æ­£åœ¨å°è¯•è¿æ¥åˆ°WiFiç½‘ç»œ...', 'warning');
                
                // ç¦ç”¨è¾“å…¥é˜²æ­¢é‡å¤æäº¤
                document.getElementById('wifiDropdown').style.backgroundColor = '';
                document.getElementById('wifiDropdown').classList.add('readonly');
                document.getElementById('wifiDropdown').style.cursor = 'not-allowed';
                document.getElementById('wifiDropdown').removeEventListener('click', toggleDropdown);
                document.getElementById('wifiPassword').disabled = true;
                document.getElementById('connectBtn').disabled = true;
                
                // å‘é€è¿æ¥è¯·æ±‚ï¼ˆä¸ç­‰å¾…å®Œæ•´å“åº”ï¼Œå› ä¸ºè®¾å¤‡å¯èƒ½ä¼šç«‹å³åˆ‡æ¢ç½‘ç»œæ¨¡å¼ï¼‰
                try {
                    fetch('/connect-wifi', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ ssid: ssid, password: password })
                    });
                    
                    // æ˜¾ç¤ºè¿æ¥æˆåŠŸçŠ¶æ€
                    showStatus('WiFiè¿æ¥è¯·æ±‚å·²å‘é€ï¼Œè®¾å¤‡æ­£åœ¨åˆ‡æ¢ç½‘ç»œæ¨¡å¼...', 'success');
                    
                    // æ·»åŠ å»¶è¿Ÿåå°è¯•å…³é—­æˆ–é‡å®šå‘ç½‘é¡µ
                    setTimeout(() => {
                        try {
                            // å°è¯•å…³é—­çª—å£ï¼ˆå¦‚æœæ˜¯é€šè¿‡è„šæœ¬æ‰“å¼€çš„çª—å£ï¼‰
                            window.close();
                            
                            // å¦‚æœçª—å£æ²¡æœ‰å…³é—­ï¼Œé‡å®šå‘åˆ°ç©ºç™½é¡µé¢
                            setTimeout(() => {
                                window.location.href = 'about:blank';
                            }, 500);
                        } catch (closeError) {
                            // å¿½ç•¥å…³é—­é”™è¯¯ï¼Œå› ä¸ºæµè§ˆå™¨å®‰å…¨é™åˆ¶å¯èƒ½é˜»æ­¢å…³é—­éè„šæœ¬æ‰“å¼€çš„çª—å£
                            console.log('æµè§ˆå™¨å®‰å…¨é™åˆ¶é˜»æ­¢å…³é—­çª—å£');
                            // é‡å®šå‘åˆ°ç©ºç™½é¡µé¢
                            window.location.href = 'about:blank';
                        }
                    }, 2000);
                } catch (error) {
                    // å¿½ç•¥é”™è¯¯ï¼Œå› ä¸ºè®¾å¤‡å¯èƒ½å·²ç»åˆ‡æ¢ç½‘ç»œæ¨¡å¼
                    console.log('è®¾å¤‡å¯èƒ½å·²åˆ‡æ¢ç½‘ç»œæ¨¡å¼ï¼Œå¿½ç•¥è¯·æ±‚é”™è¯¯');
                    
                    // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
                    showStatus('WiFiè¿æ¥è¿‡ç¨‹å·²å¼€å§‹ï¼Œè®¾å¤‡æ­£åœ¨åˆ‡æ¢ç½‘ç»œæ¨¡å¼...', 'success');
                    
                    // å³ä½¿å‘ç”Ÿé”™è¯¯ï¼Œä¹Ÿå°è¯•å…³é—­æˆ–é‡å®šå‘ç½‘é¡µ
                    setTimeout(() => {
                        window.location.href = 'about:blank';
                    }, 1000);
                }
            } catch (error) {
                console.error('è¿æ¥è¯·æ±‚å¤±è´¥:', error);
                // ä½¿ç”¨çŠ¶æ€æç¤ºæ›¿ä»£alert
                showStatus('è¿æ¥è¯·æ±‚å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚å¯èƒ½åŸå› ï¼šè®¾å¤‡æ­£åœ¨åˆ‡æ¢ç½‘ç»œæ¨¡å¼æˆ–APçƒ­ç‚¹å·²å…³é—­ã€‚', 'error');
            }
        }
        
        async function fetchIP() {
            try {
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    document.getElementById('currentIP').textContent = '192.168.1.100 (æ¨¡æ‹Ÿ)';
                    return;
                }
                
                const response = await fetch('/get-ip');
                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('currentIP').textContent = data.ip;
                } else {
                    document.getElementById('currentIP').textContent = 'é”™è¯¯: ' + (data.message || 'æœªçŸ¥é”™è¯¯');
                    console.error('è·å–IPå¤±è´¥:', data.message);
                }
            } catch (error) {
                console.error('è·å–IPè¯·æ±‚å¤±è´¥:', error);
                document.getElementById('currentIP').textContent = 'è¯·æ±‚å¤±è´¥';
            }
        }
        
        // å®æ—¶æ˜¾ç¤ºæ—¶é—´
        function updateTime() {
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                const now = new Date();
                timeElement.textContent = now.toLocaleString();
            }
        }
        
        async function fetchWifiList() {
            const wifiOptions = document.getElementById('wifiOptions');
            
            try {
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    while (wifiOptions.children.length > 1) {
                        wifiOptions.removeChild(wifiOptions.lastChild);
                    }
                    
                    const mockNetworks = ['WiFi-1', 'WiFi-2', 'WiFi-3', 'WiFi-4'];
                    mockNetworks.forEach(ssid => {
                        const option = document.createElement('div');
                        option.className = 'select-item';
                        option.setAttribute('data-value', ssid);
                        option.textContent = ssid;
                        option.addEventListener('click', function() {
                            selectWifi(this);
                        });
                        wifiOptions.appendChild(option);
                    });
                    return;
                }
                
                // æ˜¾ç¤ºæ‰«æçŠ¶æ€
                while (wifiOptions.children.length > 1) {
                    wifiOptions.removeChild(wifiOptions.lastChild);
                }
                
                const scanningOption = document.createElement('div');
                scanningOption.className = 'select-item';
                scanningOption.setAttribute('data-value', '');
                scanningOption.textContent = 'æ­£åœ¨æ‰«æWiFiç½‘ç»œ...';
                scanningOption.style.color = 'var(--text-color)';
                scanningOption.style.opacity = '0.7';
                scanningOption.style.cursor = 'wait';
                wifiOptions.appendChild(scanningOption);
                
                // ä½¿ç”¨AbortControllerå®ç°è¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.log('WiFiæ‰«æè¶…æ—¶');
                }, 15000); // 15ç§’è¶…æ—¶
                
                const response = await fetch('/scan-wifi', {
                    signal: controller.signal,
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('WiFiæ‰«æå“åº”:', data);
                
                // æ¸…é™¤æ‰«æçŠ¶æ€
                while (wifiOptions.children.length > 1) {
                    wifiOptions.removeChild(wifiOptions.lastChild);
                }
                
                if (data.status === 'success' && data.data && Array.isArray(data.data) && data.data.length > 0) {
                    console.log(`å‘ç° ${data.data.length} ä¸ªWiFiç½‘ç»œ`);
                    data.data.forEach(ssid => {
                        const option = document.createElement('div');
                        option.className = 'select-item';
                        option.setAttribute('data-value', ssid);
                        option.textContent = ssid;
                        option.addEventListener('click', function() {
                            selectWifi(this);
                        });
                        wifiOptions.appendChild(option);
                    });
                } else {
                    const option = document.createElement('div');
                    option.className = 'select-item';
                    option.setAttribute('data-value', '');
                    option.textContent = data.message || 'æœªå‘ç°WiFiç½‘ç»œ';
                    option.style.color = 'var(--text-color)';
                    option.style.opacity = '0.6';
                    option.style.cursor = 'not-allowed';
                    option.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = 'var(--card-bg)';
                    });
                    wifiOptions.appendChild(option);
                }
            } catch (error) {
                console.error('WiFiæ‰«æå¤±è´¥:', error);
                
                // æ¸…é™¤ç°æœ‰é€‰é¡¹ï¼Œä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹
                while (wifiOptions.children.length > 1) {
                    wifiOptions.removeChild(wifiOptions.lastChild);
                }
                
                let errorMessage = 'æ‰«æå¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
                let errorColor = '#f56565';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'æ‰«æè¶…æ—¶ï¼Œç‚¹å‡»é‡è¯•';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œç‚¹å‡»é‡è¯•';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'è¿æ¥å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
                }
                
                const option = document.createElement('div');
                option.className = 'select-item';
                option.setAttribute('data-value', '');
                option.textContent = errorMessage;
                option.style.color = errorColor;
                option.style.cursor = 'pointer';
                option.title = 'ç‚¹å‡»é‡æ–°æ‰«æWiFiç½‘ç»œ';
                
                // ç‚¹å‡»é‡è¯•åŠŸèƒ½
                option.addEventListener('click', function() {
                    console.log('ç”¨æˆ·ç‚¹å‡»é‡è¯•WiFiæ‰«æ');
                    fetchWifiList();
                });
                
                option.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'var(--card-bg)';
                    this.style.opacity = '0.8';
                });
                
                option.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                    this.style.opacity = '1';
                });
                
                wifiOptions.appendChild(option);
            }
        }
        
        // åˆ‡æ¢WiFiä¸‹æ‹‰èœå•æ˜¾ç¤º/éšè—
        function toggleDropdown() {
            const options = document.getElementById('wifiOptions');
            // å…³é—­å…¶ä»–å¯èƒ½æ‰“å¼€çš„ä¸‹æ‹‰èœå•
            document.querySelectorAll('.select-items').forEach(item => {
                if (item !== options) {
                    item.style.display = 'none';
                }
            });
            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        }
        
        // åˆ‡æ¢è‡ªå®šä¹‰å±‚ä¸‹æ‹‰èœå•æ˜¾ç¤º/éšè—
        function toggleCustomLayerDropdown() {
            const options = document.getElementById('customLayerOptions');
            // å…³é—­å…¶ä»–å¯èƒ½æ‰“å¼€çš„ä¸‹æ‹‰èœå•
            document.querySelectorAll('.select-items').forEach(item => {
                if (item !== options) {
                    item.style.display = 'none';
                }
            });
            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        }
        
        // é€‰æ‹©WiFi
        function selectWifi(element) {
            const value = element.getAttribute('data-value');
            const text = element.textContent;
            document.getElementById('wifiDropdown').textContent = text;
            document.getElementById('selectedWifi').value = value;
            document.getElementById('wifiOptions').style.display = 'none';
        }
        
        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(event) {
            const wifiDropdown = document.getElementById('wifiDropdown');
            const wifiOptions = document.getElementById('wifiOptions');
            const customLayerDropdown = document.getElementById('customLayerDropdown');
            const customLayerOptions = document.getElementById('customLayerOptions');
            
            // å…³é—­WiFiä¸‹æ‹‰èœå•
            if (wifiDropdown && wifiOptions && !wifiDropdown.contains(event.target) && !wifiOptions.contains(event.target)) {
                wifiOptions.style.display = 'none';
            }
            
            // å…³é—­è‡ªå®šä¹‰å±‚ä¸‹æ‹‰èœå•
            if (customLayerDropdown && customLayerOptions && !customLayerDropdown.contains(event.target) && !customLayerOptions.contains(event.target)) {
                customLayerOptions.style.display = 'none';
            }
        });
        
        function showStatus(message, type = 'success') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: 'âœ“',
                error: 'âœ•',
                warning: 'âš '
            };
            
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">${icons[type] || icons.success}</div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        function editLayerNames() {
            document.getElementById('customLayerOptions').style.display = 'none';
            
            const modal = document.getElementById('layerNameModal');
            modal.classList.add('show');
            
            loadLayerNamesToModal();
        }
        
        function closeLayerNameModal() {
            const modal = document.getElementById('layerNameModal');
            modal.classList.remove('show');
        }
        
        function loadLayerNamesToModal() {
            const container = document.getElementById('layerNameItems');
            container.innerHTML = '';
            const defaultNames = {'custom1':'è‡ªå®šä¹‰å±‚1','custom2':'è‡ªå®šä¹‰å±‚2','custom3':'è‡ªå®šä¹‰å±‚3','custom4':'è‡ªå®šä¹‰å±‚4','custom5':'è‡ªå®šä¹‰å±‚5','custom6':'è‡ªå®šä¹‰å±‚6'};
            const savedNames = JSON.parse(localStorage.getItem('customLayerNames') || '{}');
            [1,2,3,4,5,6].forEach(i => {
                const layerId = 'custom' + i;
                const currentName = savedNames[layerId] || defaultNames[layerId];
                const item = document.createElement('div');
                item.className = 'layer-name-item';
                item.innerHTML = `<span class="layer-name-label">å±‚${i}</span><input type="text" class="layer-name-input" value="${currentName}" data-layer="${layerId}" maxlength="20" placeholder="è¾“å…¥å±‚åç§°">`;
                container.appendChild(item);
            });
        }
        
        function saveLayerNames() {
            const inputs = document.querySelectorAll('.layer-name-input');
            const newNames = {};
            
            inputs.forEach(input => {
                const layerId = input.getAttribute('data-layer');
                const name = input.value.trim();
                
                if (!name) {
                    const layerNum = layerId.replace('custom', '');
                    newNames[layerId] = 'è‡ªå®šä¹‰å±‚' + layerNum;
                } else {
                    newNames[layerId] = name;
                }
            });
            
            localStorage.setItem('customLayerNames', JSON.stringify(newNames));
            
            updateCustomLayerDropdown();
            
            closeLayerNameModal();
            
            showStatus('å±‚åç§°ä¿å­˜æˆåŠŸ', 'success');
        }
        
        function updateCustomLayerDropdown() {
            const savedNames = JSON.parse(localStorage.getItem('customLayerNames') || '{}');
            
            const defaultNames = {
                'custom1': 'è‡ªå®šä¹‰å±‚1',
                'custom2': 'è‡ªå®šä¹‰å±‚2', 
                'custom3': 'è‡ªå®šä¹‰å±‚3',
                'custom4': 'è‡ªå®šä¹‰å±‚4',
                'custom5': 'è‡ªå®šä¹‰å±‚5',
                'custom6': 'è‡ªå®šä¹‰å±‚6'
            };
            
            const options = document.querySelectorAll('#customLayerOptions .select-item[data-value]');
            options.forEach(option => {
                const layerId = option.getAttribute('data-value');
                const displayName = savedNames[layerId] || defaultNames[layerId];
                option.textContent = displayName;
            });
            
            const currentDropdown = document.getElementById('customLayerDropdown');
            if (currentDropdown) {
                const activeKeymap = document.querySelector('.keymap-tab.active');
                if (activeKeymap) {
                    const layerId = activeKeymap.getAttribute('onclick').match(/switchKeymapTab\('(custom\d+)'\)/);
                    if (layerId && layerId[1]) {
                        const displayName = savedNames[layerId[1]] || defaultNames[layerId[1]];
                        currentDropdown.textContent = displayName;
                    }
                }
            }
        }
        
        function getLayerDisplayName(layerId) {
            const savedNames = JSON.parse(localStorage.getItem('customLayerNames') || '{}');
            const defaultNames = {
                'custom1': 'è‡ªå®šä¹‰å±‚1',
                'custom2': 'è‡ªå®šä¹‰å±‚2', 
                'custom3': 'è‡ªå®šä¹‰å±‚3',
                'custom4': 'è‡ªå®šä¹‰å±‚4',
                'custom5': 'è‡ªå®šä¹‰å±‚5',
                'custom6': 'è‡ªå®šä¹‰å±‚6'
            };
            
            return savedNames[layerId] || defaultNames[layerId];
        }
        
        // è·å–æŒ‰é”®åˆ†ç»„
        function getKeyGroup(keyCode) {
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦ä¸ºç»„åˆé”®
            if (isComboKey(keyCode)) {
                return 'ç»„åˆé”®';
            }
            
            // æ— åŠŸèƒ½é”® (å€¼ä¸º0)
            if (keyCode === 0) return 'æ— åŠŸèƒ½é”®';
            
            // å­—æ¯é”® (A-Z: 0x0004-0x001D)
            if (keyCode >= 0x0004 && keyCode <= 0x001D) return 'å­—æ¯é”®';
            // æ•°å­—é”® (1-0: 0x001E-0x0027)
            if (keyCode >= 0x001E && keyCode <= 0x0027) return 'æ•°å­—é”®';
            // åŠŸèƒ½é”® (F1-F12: 0x003A-0x0045)
            if (keyCode >= 0x003A && keyCode <= 0x0045) return 'åŠŸèƒ½é”®';
            // æ–¹å‘é”® (0x004F-0x0052)
            if (keyCode >= 0x004F && keyCode <= 0x0052) return 'æ–¹å‘é”®';
            // ç‰¹æ®Šé”® (Enter, Space, Tab, Backspace, etc.)
            if (keyCode >= 0x0028 && keyCode <= 0x0039) return 'ç‰¹æ®Šé”®';
            // å°é”®ç›˜é”® (0x0053-0x0063)
            if (keyCode >= 0x0053 && keyCode <= 0x0063) return 'ç‰¹æ®Šé”®';
            // å…¶ä»–ç³»ç»Ÿé”®
            if (keyCode >= 0x0046 && keyCode <= 0x004E) return 'ç‰¹æ®Šé”®';
            // å¤šåª’ä½“é”® (æ ¹æ®keycodes.hä¸­çš„å®šä¹‰)
            // éŸ³é¢‘æ§åˆ¶é”®: KC_AUDIO_MUTE (0x00A8) åˆ° KC_MEDIA_SELECT (0x00AF)
            if (keyCode >= 0x00A8 && keyCode <= 0x00AF) return 'å¤šåª’ä½“é”®';
            // åª’ä½“æ§åˆ¶é”®: KC_MEDIA_EJECT (0x00B0) åˆ° KC_MEDIA_REWIND (0x00BC)
            if (keyCode >= 0x00B0 && keyCode <= 0x00BC) return 'å¤šåª’ä½“é”®';
            // äº®åº¦æ§åˆ¶é”®: KC_BRIGHTNESS_UP (0x00BD) åˆ° KC_BRIGHTNESS_DOWN (0x00BE)
            if (keyCode >= 0x00BD && keyCode <= 0x00BE) return 'å¤šåª’ä½“é”®';
            // æ ‡å‡†æ§åˆ¶é”® (Ctrl, Shift, Alt, Win: 0x00E0-0x00E7)
            if (keyCode >= 0x00E0 && keyCode <= 0x00E7) return 'æ§åˆ¶é”®';
            
            return 'å…¶ä»–é”®';
        }
        
        // æŒ‰é”®åˆ†ç»„è¿‡æ»¤åŠŸèƒ½
        function filterKeysByGroup() {
            const groupSelect = document.getElementById('keyGroupSelect');
            const selectedGroup = groupSelect.value;
            
            // è·å–æ‰€æœ‰æŒ‰é”®å…ƒç´ ï¼ˆåŒ…æ‹¬.key-itemå®¹å™¨å’Œ.key-selecté€‰æ‹©å™¨ï¼‰
            const keyItems = document.querySelectorAll('.key-item');
            
            keyItems.forEach(keyItem => {
                const select = keyItem.querySelector('.key-select');
                if (select) {
                    // æ˜¾ç¤ºæ‰€æœ‰æŒ‰é”®ï¼ŒæŒ‰é”®éƒ½èƒ½ä¿®æ”¹
                    keyItem.style.display = 'block';
                    
                    // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
                    const currentValue = select.value;
                    
                    // é‡æ–°ç”Ÿæˆé€‰é¡¹åˆ—è¡¨ï¼Œæ ¹æ®å½“å‰åˆ†ç»„è¿‡æ»¤
                    select.innerHTML = getMergedKeyOptions(parseInt(currentValue) || currentValue);
                    
                    // æ£€æŸ¥å½“å‰å€¼æ˜¯å¦åœ¨æ–°ç”Ÿæˆçš„é€‰é¡¹ä¸­
                    const hasCurrentValue = select.querySelector(`option[value="${currentValue}"]`);
                    if (!hasCurrentValue && currentValue !== '0' && currentValue !== 'custom') {
                        // å¦‚æœå½“å‰å€¼ä¸åœ¨æ–°åˆ†ç»„çš„é€‰é¡¹ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªä¸´æ—¶é€‰é¡¹æ¥ä¿ç•™å½“å‰å€¼
                        const tempOption = document.createElement('option');
                        tempOption.value = currentValue;
                        tempOption.textContent = getKeyName(parseInt(currentValue));
                        tempOption.selected = true;
                        select.appendChild(tempOption);
                    }
                }
            });
        }
        
        // ä¸»é¢˜ç®¡ç†åŠŸèƒ½
        let themeMode = 'auto'; // 'auto', 'light', 'dark'
        
        function initTheme() {
            // ä»localStorageè·å–ä¿å­˜çš„ä¸»é¢˜æ¨¡å¼
            const savedMode = localStorage.getItem('themeMode') || 'auto';
            themeMode = savedMode;
            
            applyTheme();
            
            // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (themeMode === 'auto') {
                    applyTheme();
                }
            });
        }
        
        function applyTheme() {
            let actualTheme;
            
            if (themeMode === 'auto') {
                // è‡ªåŠ¨æ¨¡å¼ï¼šè·Ÿéšç³»ç»Ÿåå¥½
                try {
                    const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    if (isMobile) {
                        // ç§»åŠ¨è®¾å¤‡å¢å¼ºæ£€æµ‹
                        console.log('ç§»åŠ¨è®¾å¤‡æ·±è‰²æ¨¡å¼æ£€æµ‹ - åª’ä½“æŸ¥è¯¢æ”¯æŒ:', darkModeMediaQuery.media !== 'not all');
                        console.log('ç§»åŠ¨è®¾å¤‡æ·±è‰²æ¨¡å¼æ£€æµ‹ - å½“å‰çŠ¶æ€:', darkModeMediaQuery.matches);
                        
                        // æ£€æŸ¥åª’ä½“æŸ¥è¯¢æ˜¯å¦è¢«æ”¯æŒ
                        if (darkModeMediaQuery.media === 'not all') {
                            // åª’ä½“æŸ¥è¯¢ä¸æ”¯æŒï¼Œä½¿ç”¨æ—¶é—´ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                            const currentHour = new Date().getHours();
                            actualTheme = (currentHour < 7 || currentHour > 19) ? 'dark' : 'light';
                            console.log('ç§»åŠ¨è®¾å¤‡ä½¿ç”¨æ—¶é—´å¤‡ç”¨æ–¹æ¡ˆ:', actualTheme, '(å½“å‰æ—¶é—´:', currentHour, ')');
                        } else {
                            actualTheme = darkModeMediaQuery.matches ? 'dark' : 'light';
                        }
                    } else {
                        // æ¡Œé¢è®¾å¤‡æ ‡å‡†æ£€æµ‹
                        actualTheme = darkModeMediaQuery.matches ? 'dark' : 'light';
                    }
                } catch (error) {
                    console.warn('ä¸»é¢˜æ£€æµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æµ…è‰²ä¸»é¢˜:', error);
                    actualTheme = 'light';
                }
            } else {
                // æ‰‹åŠ¨æ¨¡å¼ï¼šä½¿ç”¨æŒ‡å®šä¸»é¢˜
                actualTheme = themeMode;
            }
            
            document.documentElement.setAttribute('data-theme', actualTheme);
            updateThemeButton();
            
            console.log('åº”ç”¨ä¸»é¢˜:', themeMode, '->', actualTheme);
        }
        
        function toggleTheme() {
            // å¾ªç¯åˆ‡æ¢ï¼šè‡ªåŠ¨ -> æµ…è‰² -> æ·±è‰² -> è‡ªåŠ¨
            if (themeMode === 'auto') {
                themeMode = 'light';
            } else if (themeMode === 'light') {
                themeMode = 'dark';
            } else {
                themeMode = 'auto';
            }
            
            console.log('åˆ‡æ¢ä¸»é¢˜æ¨¡å¼:', themeMode);
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('themeMode', themeMode);
            
            // åº”ç”¨æ–°ä¸»é¢˜
            applyTheme();
            
            // æ˜¾ç¤ºåˆ‡æ¢æç¤º
            let message;
            if (themeMode === 'auto') {
                message = 'å·²åˆ‡æ¢åˆ°è‡ªåŠ¨æ¨¡å¼ï¼ˆè·Ÿéšç³»ç»Ÿï¼‰';
            } else if (themeMode === 'light') {
                message = 'å·²åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼';
            } else {
                message = 'å·²åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼';
            }
            showStatus(message, 'success');
        }
        
        function updateThemeButton() {
            const themeIcon = document.querySelector('.theme-icon');
            const themeText = document.querySelector('.theme-text');
            
            if (themeIcon && themeText) {
                if (themeMode === 'auto') {
                    themeIcon.textContent = 'ğŸŒ“';
                    themeText.textContent = 'è‡ªåŠ¨';
                } else if (themeMode === 'dark') {
                    themeIcon.textContent = 'ğŸŒ™';
                    themeText.textContent = 'æ·±è‰²';
                } else {
                    themeIcon.textContent = 'â˜€ï¸';
                    themeText.textContent = 'æµ…è‰²';
                }
            }
        }
        
        window.onload = async function() {
            // åˆå§‹åŒ–ä¸»é¢˜
            initTheme();
            
            await fetchNumKeys();
            initCustomKeymapsStorage();
            fetchIP();
            fetchWifiList();
            updateTime();
            setInterval(updateTime, 1000);
            document.getElementById('connectBtn').addEventListener('click', connectWifi);
            document.getElementById('wifiDropdown').addEventListener('click', toggleDropdown);
            document.getElementById('customLayerDropdown').addEventListener('click', toggleCustomLayerDropdown);
            document.querySelector('#wifiOptions .select-item').addEventListener('click', function() { selectWifi(this); });
            
            // ä¸ºæŒ‰é”®åˆ†ç»„é€‰æ‹©å™¨æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const keyGroupSelect = document.getElementById('keyGroupSelect');
            if (keyGroupSelect) {
                keyGroupSelect.addEventListener('change', filterKeysByGroup);
            }
            
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(() => {
                [1,2,3,4,5,6].forEach(layer => initCustomKeymap(layer));
                updateCustomLayerDropdown();
            }, 100);
        };
    </script>
</body>
</html>